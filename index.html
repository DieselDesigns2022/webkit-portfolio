<!-- File: index.html (Viewer default; Admin via ?mode=admin) -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Webkit Options for Diesel Designs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root { --brand: #8D6CE5; }
      .no-select { user-select: none; -webkit-user-select: none; }
      body { -webkit-touch-callout: none; }
      img { -webkit-user-drag: none; }
    </style>
  </head>
  <body class="min-h-screen bg-zinc-50 text-zinc-900">
    <!-- Header: centered logo + title; controls below -->
    <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b" style="border-color:var(--brand)">
      <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col gap-3">
        <div class="flex flex-col items-center justify-center gap-2">
          <img src="https://cdn.shopify.com/s/files/1/0659/3023/2034/files/LogowithWebsite_3b736bf3-8f06-4553-bed2-68878cd7395a.png?v=1757448093" alt="Diesel Designs" class="h-20 w-auto" />
          <h1 id="appTitle" class="text-2xl font-semibold tracking-tight text-center">Webkit Options</h1>
        </div>
        <div class="flex items-center justify-between">
          <span id="status" class="text-xs text-zinc-500"></span>
          <div id="adminBar" class="hidden items-center gap-2">
            <label class="px-3 py-2 rounded-xl bg-zinc-100 hover:bg-zinc-200 cursor-pointer">
              <input id="importJsonInput" type="file" accept="application/json" class="hidden" />Import JSON
            </label>
            <button id="exportJsonBtn" class="px-3 py-2 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800">Export gallery.json</button>
            <div class="mx-1 w-px h-6 bg-zinc-200"></div>
            <button id="addFilesBtn" class="px-3 py-2 rounded-xl bg-zinc-100 hover:bg-zinc-200">Add Files</button>
            <input id="fileInput" type="file" accept="image/*" multiple class="hidden" />
          </div>
          <div id="viewerBar" class="hidden items-center gap-2">
            <div class="inline-flex rounded-xl border overflow-hidden" style="border-color:var(--brand)">
              <button id="gridBtn" class="px-3 py-2 text-sm" style="background-color: color-mix(in srgb, var(--brand) 10%, transparent)">Grid</button>
              <button id="flipBtn" class="px-3 py-2 text-sm">Flipbook</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-4">
      <!-- ADMIN -->
      <section id="adminUI" class="hidden space-y-4">
        <div class="rounded-2xl border bg-white p-4">
          <h2 class="font-semibold mb-2">Add images</h2>
          <div id="dropzone" class="border-2 border-dashed rounded-2xl p-6 text-center text-sm text-zinc-500 bg-zinc-50">
            Drag & drop files here, or <span class="underline">click to browse</span>
          </div>
          <p class="text-xs text-zinc-500 mt-2">JPG/PNG images. Edit Title and Category below.</p>
        </div>

        <div id="itemsWrap" class="rounded-2xl border bg-white">
          <div class="flex items-center justify-between p-3 border-b">
            <div class="text-sm font-medium">Items</div>
            <div class="flex items-center gap-2">
              <button id="clearItemsBtn" class="text-xs px-2 py-1 rounded-lg bg-zinc-100 hover:bg-zinc-200">Clear</button>
            </div>
          </div>
          <div id="itemsList" class="divide-y"></div>
        </div>

        <div class="rounded-2xl border bg-amber-50 text-amber-900 p-3 text-sm">
          After exporting <code>gallery.json</code>, upload it to your repo root (same place as <code>index.html</code>). The Viewer will load it automatically.
        </div>
      </section>

      <!-- VIEWER -->
      <section id="viewerUI" class="hidden space-y-4">
        <div id="banner" class="hidden p-3 rounded-xl border bg-amber-50 text-amber-900 text-sm"></div>
        <div id="note" class="p-3 rounded-xl border bg-zinc-100 text-zinc-800 text-sm">
          âœ¨ Thanks for choosing <b>Diesel Designs</b> for your website revamp! Browse the webkit themes below. Click any image to enlarge. The webkit name is under each previewâ€”please enter that exact name on the form. ðŸ’»
        </div>
        <div id="catTabs" class="flex flex-wrap gap-2"></div>
        <section id="gridView" class="grid gap-6"></section>
        <section id="flipView" class="hidden">
          <div class="relative rounded-2xl border bg-white overflow-hidden">
            <div id="flipViewport" class="w-full h-[62vh] md:h-[66vh] lg:h-[70vh] grid place-items-center bg-zinc-50 no-select"></div>
            <button id="prevBtn" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white px-3 py-2 rounded-xl border shadow">â€¹</button>
            <button id="nextBtn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white px-3 py-2 rounded-xl border shadow">â€º</button>
            <div class="absolute left-2 bottom-2 bg-white/90 px-2 py-1 rounded-lg text-sm font-medium" id="flipMeta"></div>
            <select id="speedSel" class="absolute right-28 bottom-2 bg-white/90 border rounded-lg px-2 py-1 text-xs">
              <option value="2000">2s</option>
              <option value="3000" selected>3s</option>
              <option value="5000">5s</option>
              <option value="8000">8s</option>
            </select>
            <button id="playBtn" class="absolute right-2 bottom-2 text-white hover:opacity-90 px-3 py-2 rounded-xl border shadow text-sm" style="background:var(--brand); border-color:var(--brand)">Play</button>
          </div>
        </section>
      </section>
    </main>

    <footer class="max-w-6xl mx-auto px-4 py-8 text-center text-xs text-zinc-500">
      Â© <span id="year"></span> Diesel Designs
    </footer>

    <!-- Admin item row template -->
    <template id="itemRowTpl">
      <div class="p-3 flex items-start gap-3">
        <img class="w-24 h-24 object-cover rounded-lg bg-zinc-100" />
        <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-2">
          <label class="text-xs text-zinc-500">Title
            <input class="w-full mt-1 px-3 py-2 rounded-xl border focus:outline-none focus:ring-2 focus:ring-zinc-900" />
          </label>
          <label class="text-xs text-zinc-500">Category
            <input class="w-full mt-1 px-3 py-2 rounded-xl border focus:outline-none focus:ring-2 focus:ring-zinc-900" />
          </label>
        </div>
        <button class="shrink-0 text-xs px-2 py-1 rounded-lg bg-red-50 text-red-700 hover:bg-red-100">Remove</button>
      </div>
    </template>

    <!-- Lightbox overlay -->
    <div id="lightbox" class="fixed inset-0 bg-black/80 backdrop-blur flex items-center justify-center p-4 z-50 hidden" onclick="closeLightbox()">
      <button class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white border rounded-xl px-3 py-2" onclick="event.stopPropagation(); lbStep(-1)">â€¹</button>
      <div class="max-w-7xl w-full" onclick="event.stopPropagation()">
        <img id="lbImg" alt="Full image" class="mx-auto max-w-[90vw] max-h-[85vh] rounded-xl shadow" draggable="false" />
        <div id="lbCaption" class="mt-2 text-center text-sm text-white/90"></div>
      </div>
      <button class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white border rounded-xl px-3 py-2" onclick="event.stopPropagation(); lbStep(1)">â€º</button>
      <button class="absolute top-4 right-4 bg-white/90 hover:bg-white border rounded-xl px-3 py-2" onclick="event.stopPropagation(); closeLightbox()">Close</button>
    </div>

    <script>
      // ---------- Mode ----------
      const params = new URLSearchParams(location.search);
      const mode = (params.get('mode')||'view').toLowerCase();

      // ---------- State ----------
      const App = { items: [], view: 'grid', flat: [], title: 'Webkit Options', filter: 'all' };
      const $ = (s,r=document)=>r.querySelector(s);
      const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
      const status = $('#status');

      // Deter saving
      document.addEventListener('contextmenu', e=>e.preventDefault());
      document.addEventListener('dragstart', e=>e.preventDefault());

      (async function init(){
        $('#year').textContent = new Date().getFullYear();
        if (mode==='admin') initAdmin(); else await initViewer();
      })();

      // ---------------- ADMIN ----------------
      function initAdmin(){
        $('#adminUI').classList.remove('hidden');
        $('#adminBar').classList.remove('hidden');
        $('#appTitle').textContent = 'Webkit Options â€” Admin';
        const drop=$('#dropzone'); const fileInput=$('#fileInput'); const addBtn=$('#addFilesBtn');
        const importInput=$('#importJsonInput'); const exportBtn=$('#exportJsonBtn'); const clearBtn=$('#clearItemsBtn');
        addBtn.onclick=()=>fileInput.click(); drop.onclick=()=>fileInput.click();
        drop.ondragover=e=>{e.preventDefault(); drop.classList.add('border-zinc-400');};
        drop.ondragleave=()=>drop.classList.remove('border-zinc-400');
        drop.ondrop=e=>{e.preventDefault(); drop.classList.remove('border-zinc-400'); handleFiles(e.dataTransfer.files);};
        fileInput.onchange=()=>handleFiles(fileInput.files);
        importInput.onchange=async (e)=>{ const f=e.target.files?.[0]; if(!f) return; await importJSON(await f.text()); e.target.value=''; };
        exportBtn.onclick=exportJSON; clearBtn.onclick=()=>{ if(confirm('Remove all items?')){App.items=[]; renderAdminList();} };
        renderAdminList();
      }
      async function handleFiles(files){
        const arr=[...files]; if(!arr.length) return; setStatus('Readingâ€¦');
        for(const f of arr){ if(!f.type.startsWith('image/')) continue; const dataUrl=await fileToDataURL(f); const [mime,data]=splitDataUrl(dataUrl); App.items.push({ title:stripExt(f.name), category:'', mime, data }); }
        renderAdminList(); setStatus(`Ready (${App.items.length})`); setTimeout(()=>setStatus(''),800);
      }
      function renderAdminList(){
        const list=$('#itemsList'); list.innerHTML=''; const tpl=$('#itemRowTpl');
        if(!App.items.length){ list.innerHTML='<div class="p-4 text-sm text-zinc-500">No items yet. Add files above.</div>'; return; }
        App.items.forEach((it,idx)=>{
          const row=tpl.content.cloneNode(true);
          const img=$('img',row); img.src=`data:${it.mime};base64,${it.data}`;
          const inputs=$$('input',row);
          const title=inputs[0]; const cat=inputs[1];
          title.value = it.title || ''; title.oninput = e => it.title = e.target.value;
          cat.value = it.category || ''; cat.oninput = e => it.category = e.target.value;
          const rm=$('button',row); rm.onclick=()=>{App.items.splice(idx,1); renderAdminList();};
          list.appendChild(row);
        });
      }
      async function importJSON(text){
        try{
          const obj=JSON.parse(text);
          if(!Array.isArray(obj.items)) throw new Error('Invalid');
          App.items = obj.items.map(x=>({ title:x.title||'Untitled', category:x.category||'', mime:x.mime||'image/jpeg', data:x.data }));
          renderAdminList(); setStatus(`Imported ${App.items.length}`); setTimeout(()=>setStatus(''),800);
        } catch(e) { alert('Import failed: ' + (e.message||e)); }
      }
      function exportJSON(){
        if(!App.items.length) return alert('Nothing to export');
        const out={ version:1, generatedAt:new Date().toISOString(), title:App.title, items:App.items };
        const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='gallery.json'; a.click(); URL.revokeObjectURL(a.href);
      }

      // ---------------- VIEWER ----------------
      async function initViewer(){
        $('#viewerUI').classList.remove('hidden');
        $('#viewerBar').classList.remove('hidden');
        $('#appTitle').textContent = 'Webkit Options';
        $('#gridBtn').onclick = ()=>{ App.view='grid'; renderAll(); syncURL(); };
        $('#flipBtn').onclick = ()=>{ App.view='flip'; renderAll(); syncURL(); };
        window.addEventListener('keydown', (e)=>{ if (App.view==='flip'){ if (e.key==='ArrowLeft') step(-1); if (e.key==='ArrowRight') step(1); }});
        try {
          const res = await fetch('./gallery.json', { cache:'no-store' });
          if (!res.ok) throw new Error('missing');
          const json = await res.json();
          App.items = (json.items||[]).map(x=>({ title:x.title||'Untitled', category:x.category||'', src:`data:${x.mime||'image/jpeg'};base64,${x.data}` }));
          setBanner('');
        } catch (e) {
          setBanner('Could not find <code>gallery.json</code> in the repo root (same place as <code>index.html</code>). Use <code>?mode=admin</code> to export one, then upload it.');
          App.items=[];
        }
        renderAll();
      }

      function setBanner(html){ const b=$('#banner'); if(!html){b.classList.add('hidden'); b.innerHTML=''; return;} b.classList.remove('hidden'); b.innerHTML=html; }
      function setStatus(msg){ if (mode==='admin') status.textContent = msg||''; else status.textContent=''; }
      function syncURL(){ const u=new URL(location); u.searchParams.set('mode','view'); u.searchParams.set('view', App.view==='flip'?'flip':'grid'); history.replaceState({},'',u); }

      function renderAll(){
        renderTabs();
        $('#gridBtn').style.backgroundColor = (App.view==='grid') ? 'color-mix(in srgb, var(--brand) 10%, transparent)' : '';
        $('#flipBtn').style.backgroundColor = (App.view==='flip') ? 'color-mix(in srgb, var(--brand) 10%, transparent)' : '';
        if (App.view==='grid'){ stopAutoplay(); $('#gridView').classList.remove('hidden'); $('#flipView').classList.add('hidden'); renderGrid(); }
        else { $('#gridView').classList.add('hidden'); $('#flipView').classList.remove('hidden'); renderFlip(); }
      }

      function renderTabs(){
        const ct = document.getElementById('catTabs'); if (!ct) return;
        ct.innerHTML = '';
        const unique = Array.from(new Set(App.items.map(i => (i.category||'')).filter(Boolean)));
        const cats = ['all', ...unique];
        cats.forEach(cat => {
          const btn = document.createElement('button');
          const active = (App.filter === cat) || (cat==='all' && App.filter==='all');
          btn.className = 'px-3 py-1.5 text-sm rounded-xl border ' + (active ? 'bg-[color:var(--brand)] text-white border-[color:var(--brand)]' : 'bg-white hover:bg-zinc-50');
          btn.textContent = cat==='all' ? 'View All' : cat;
          btn.onclick = ()=>{ App.filter = cat; renderAll(); };
          ct.appendChild(btn);
        });
        ct.classList.remove('hidden');
      }

      function renderGrid(){
        const host=$('#gridView'); host.innerHTML='';
        if(!App.items.length){ host.innerHTML='<div class="text-sm text-zinc-500">No items to show.</div>'; return; }
        const grid=document.createElement('div'); grid.className='grid gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4';
        const list = App.filter==='all' ? App.items : App.items.filter(i=>i.category===App.filter);
        lbList = list;
        list.forEach((it,i)=>grid.appendChild(gridCard(it,i)));
        host.appendChild(grid);
      }

      function gridCard(it, i){
        const fig=document.createElement('figure'); fig.className='rounded-2xl overflow-hidden border bg-white cursor-zoom-in';
        const img=new Image(); img.src=it.src; img.alt=it.title||''; img.loading='lazy'; img.className='w-full h-48 object-cover bg-zinc-100'; img.draggable=false;
        const cap=document.createElement('figcaption'); cap.className='p-2 text-lg font-semibold text-zinc-900';
        cap.innerHTML=`<span class="truncate" title="${escapeHtml(it.title)}">${escapeHtml(it.title)}</span>`;
        fig.appendChild(img); fig.appendChild(cap); fig.addEventListener('click', ()=> openLightbox(i));
        return fig;
      }

      // Flipbook
      let idx=0, autoTimer=null, autoMs=3000;
      function renderFlip(){
        const list = App.filter==='all' ? App.items : App.items.filter(i=>i.category===App.filter);
        App.flat=list; if(!list.length){ $('#flipViewport').innerHTML='<div class="text-sm text-zinc-500">No items.</div>'; $('#flipMeta').textContent=''; return; }
        if(idx>=list.length) idx=0; showSlide();
        $('#prevBtn').onclick=()=>step(-1); $('#nextBtn').onclick=()=>step(1);
        const playBtn=$('#playBtn'); const speedSel=$('#speedSel');
        if(playBtn) playBtn.onclick=()=>{ if(autoTimer) stopAutoplay(); else startAutoplay(); };
        if(speedSel) speedSel.onchange=(e)=>{ autoMs=parseInt(e.target.value,10)||3000; if(autoTimer) startAutoplay(); };
        const vp=$('#flipViewport'); let sx=0,sy=0,tr=false; vp.onpointerdown=e=>{tr=true;sx=e.clientX;sy=e.clientY}; vp.onpointerup=e=>{ if(!tr)return; tr=false; const dx=e.clientX-sx,dy=e.clientY-sy; if(Math.abs(dx)>40&&Math.abs(dx)>Math.abs(dy)) step(dx<0?1:-1); };
      }
      function showSlide(){ const it=App.flat[idx]; const vp=$('#flipViewport'); vp.innerHTML=''; const img=new Image(); img.src=it.src; img.alt=it.title||''; img.className='max-w-full max-h-full rounded-lg shadow'; img.draggable=false; vp.appendChild(img); const meta=`${idx+1} / ${App.flat.length} â€¢ ${it.title}`; const metaEl=$('#flipMeta'); if(metaEl) metaEl.textContent=meta; }
      function startAutoplay(){ stopAutoplay(); autoTimer=setInterval(()=>step(1), autoMs); const b=$('#playBtn'); if(b) b.textContent='Pause'; }
      function stopAutoplay(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } const b=$('#playBtn'); if(b) b.textContent='Play'; }
      function step(d){ idx=(idx+d+App.flat.length)%App.flat.length; showSlide(); }

      // Lightbox
      let lbOpen=false, lbIdx=0, lbList=[];
      function openLightbox(i){ lbIdx=i; const lb=$('#lightbox'), img=$('#lbImg'), cap=$('#lbCaption'); const it=lbList[lbIdx]; if(!it||!lb||!img)return; img.src=it.src; img.alt=it.title||''; if(cap) cap.textContent=it.title||''; lb.classList.remove('hidden'); lbOpen=true; }
      function closeLightbox(){ const lb=$('#lightbox'); if(lb) lb.classList.add('hidden'); lbOpen=false; }
      function lbStep(d){ if(!lbList.length) return; lbIdx=(lbIdx+d+lbList.length)%lbList.length; const it=lbList[lbIdx]; const img=$('#lbImg'); const cap=$('#lbCaption'); if(img&&it){ img.src=it.src; img.alt=it.title||''; } if(cap) cap.textContent=it.title||''; }
      document.addEventListener('keydown', (e)=>{ if(!lbOpen) return; if(e.key==='Escape') closeLightbox(); if(e.key==='ArrowLeft') lbStep(-1); if(e.key==='ArrowRight') lbStep(1); });

      // Utils
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
      function stripExt(n){ return n.replace(/\.[^.]+$/, '').replace(/[-_]+/g,' ').trim(); }
      function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
      function splitDataUrl(dataUrl){ const m=String(dataUrl).match(/^data:([^;]+);base64,(.*)$/); return [m?.[1]||'image/jpeg', m?.[2]||'']; }
    </script>
  </body>
</html>
