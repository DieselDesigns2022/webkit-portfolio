<!-- File: index.html (Admin + Viewer)
Why: Single static file with two interfaces. Admin prepares a gallery JSON; Viewer renders it.
Workflow:
  1) Admin mode: open with ?mode=admin → upload images, add titles/categories → Export JSON (downloads gallery.json)
  2) Upload that gallery.json to your repo root (same folder as index.html)
  3) Viewer mode: open without params (or ?mode=view) → site fetches gallery.json and shows Grid/Flipbook to customers
-->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Portfolio — Admin & Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>.no-select{user-select:none;-webkit-user-select:none}</style>
  </head>
  <body class="min-h-screen bg-zinc-50 text-zinc-900">
    <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-black text-white grid place-items-center font-bold">PF</div>
        <h1 id="appTitle" class="text-lg font-semibold tracking-tight">Portfolio</h1>
        <span id="status" class="text-xs text-zinc-500"></span>
        <div id="adminBar" class="ml-auto hidden items-center gap-2">
          <label class="px-3 py-2 rounded-xl bg-zinc-100 hover:bg-zinc-200 cursor-pointer">
            <input id="importJsonInput" type="file" accept="application/json" class="hidden" />Import JSON
          </label>
          <button id="exportJsonBtn" class="px-3 py-2 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800">Export gallery.json</button>
          <div class="mx-1 w-px h-6 bg-zinc-200"></div>
          <button id="addFilesBtn" class="px-3 py-2 rounded-xl bg-zinc-100 hover:bg-zinc-200">Add Files</button>
          <input id="fileInput" type="file" accept="image/*" multiple class="hidden" />
        </div>
        <div id="viewerBar" class="ml-auto hidden items-center gap-2">
          <div class="inline-flex rounded-xl border overflow-hidden">
            <button id="gridBtn" class="px-3 py-2 text-sm bg-zinc-100">Grid</button>
            <button id="flipBtn" class="px-3 py-2 text-sm">Flipbook</button>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-4">
      <!-- Admin UI -->
      <section id="adminUI" class="hidden space-y-4">
        <div class="rounded-2xl border bg-white p-4">
          <h2 class="font-semibold mb-2">Add images</h2>
          <div id="dropzone" class="border-2 border-dashed rounded-2xl p-6 text-center text-sm text-zinc-500 bg-zinc-50">
            Drag & drop files here, or <span class="underline">click to browse</span>
          </div>
          <p class="text-xs text-zinc-500 mt-2">Images only (JPG/PNG). Titles and categories are editable below.</p>
        </div>

        <div id="itemsWrap" class="rounded-2xl border bg-white">
          <div class="flex items-center justify-between p-3 border-b">
            <div class="text-sm font-medium">Items</div>
            <div class="flex items-center gap-2">
              <button id="clearItemsBtn" class="text-xs px-2 py-1 rounded-lg bg-zinc-100 hover:bg-zinc-200">Clear</button>
            </div>
          </div>
          <div id="itemsList" class="divide-y"></div>
        </div>

        <div class="rounded-2xl border bg-amber-50 text-amber-900 p-3 text-sm">
          After exporting <code>gallery.json</code>, upload it to your repo root (same place as <code>index.html</code>). The Viewer will load it automatically.
        </div>
      </section>

      <!-- Viewer UI -->
      <section id="viewerUI" class="hidden space-y-4">
        <div id="banner" class="hidden p-3 rounded-xl border bg-amber-50 text-amber-900 text-sm"></div>
        <div id="catTabs" class="flex flex-wrap gap-2"></div>
        <section id="gridView" class="grid gap-6"></section>
        <section id="flipView" class="hidden">
          <div class="relative rounded-2xl border bg-white overflow-hidden">
            <div id="flipViewport" class="w-full aspect-[16/10] md:aspect-[16/9] grid place-items-center bg-zinc-50 no-select"></div>
            <button id="prevBtn" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white px-3 py-2 rounded-xl border shadow">‹</button>
            <button id="nextBtn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white px-3 py-2 rounded-xl border shadow">›</button>
            <div class="absolute left-2 bottom-2 bg-white/90 px-2 py-1 rounded-lg text-xs" id="flipMeta"></div>
          </div>
        </section>
      </section>
    </main>

    <footer class="max-w-6xl mx-auto px-4 py-8 text-center text-xs text-zinc-500">
      © <span id="year"></span> Your Name
    </footer>

    <template id="itemRowTpl">
      <div class="p-3 flex items-start gap-3">
        <img class="w-24 h-24 object-cover rounded-lg bg-zinc-100" />
        <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-2">
          <label class="text-xs text-zinc-500">Title
            <input class="w-full mt-1 px-3 py-2 rounded-xl border focus:outline-none focus:ring-2 focus:ring-zinc-900" />
          </label>
          <label class="text-xs text-zinc-500">Category (optional)
            <input class="w-full mt-1 px-3 py-2 rounded-xl border focus:outline-none focus:ring-2 focus:ring-zinc-900" />
          </label>
        </div>
        <button class="shrink-0 text-xs px-2 py-1 rounded-lg bg-red-50 text-red-700 hover:bg-red-100">Remove</button>
      </div>
    </template>

    <script>
      // ---------- Mode detection ----------
      const params = new URLSearchParams(location.search);
      const mode = (params.get('mode')||'view').toLowerCase(); // 'admin' or 'view'

      // ---------- State ----------
      const App = {
        items: [],         // Admin: {title, category, mime, data}, Viewer: normalized with src
        view: 'grid',      // 'grid' | 'flip'
        filter: 'all',
        flat: [],
        title: 'Portfolio',
      };

      // ---------- Elements ----------
      const $ = (s, r=document)=>r.querySelector(s);
      const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
      const status = $('#status');

      // ---------- Boot ----------
      (async function init(){
        $('#year').textContent = new Date().getFullYear();
        if (mode === 'admin') initAdmin(); else await initViewer();
      })();

      // ---------- Admin ----------
      function initAdmin(){
        $('#adminUI').classList.remove('hidden');
        $('#adminBar').classList.remove('hidden');
        $('#appTitle').textContent = 'Portfolio — Admin';

        const drop = $('#dropzone');
        const fileInput = $('#fileInput');
        const addBtn = $('#addFilesBtn');
        const importInput = $('#importJsonInput');
        const exportBtn = $('#exportJsonBtn');
        const clearBtn = $('#clearItemsBtn');

        addBtn.onclick = ()=>fileInput.click();
        drop.onclick = ()=>fileInput.click();
        drop.ondragover = (e)=>{ e.preventDefault(); drop.classList.add('border-zinc-400'); };
        drop.ondragleave = ()=>drop.classList.remove('border-zinc-400');
        drop.ondrop = (e)=>{ e.preventDefault(); drop.classList.remove('border-zinc-400'); handleFiles(e.dataTransfer.files); };
        fileInput.onchange = ()=>handleFiles(fileInput.files);
        importInput.onchange = async (e)=>{ const f=e.target.files?.[0]; if (!f) return; await importJSON(await f.text()); e.target.value=''; };
        exportBtn.onclick = exportJSON;
        clearBtn.onclick = ()=>{ if (confirm('Remove all items?')) { App.items=[]; renderAdminList(); }};

        renderAdminList();
      }

      async function handleFiles(files){
        const arr = [...files]; if (!arr.length) return;
        setStatus('Reading…');
        for (const f of arr) {
          if (!f.type.startsWith('image/')) continue;
          const dataUrl = await fileToDataURL(f);
          const [mime, data] = splitDataUrl(dataUrl);
          App.items.push({ title: stripExt(f.name), category: '', mime, data });
        }
        renderAdminList(); setStatus('Ready'); setTimeout(()=>setStatus(''), 800);
      }

      function renderAdminList(){
        const list = $('#itemsList'); list.innerHTML='';
        const tpl = $('#itemRowTpl');
        if (!App.items.length) { list.innerHTML = '<div class="p-4 text-sm text-zinc-500">No items yet. Add files above.</div>'; return; }
        App.items.forEach((it, idx)=>{
          const row = tpl.content.cloneNode(true);
          const img = $('img', row); img.src = toSrc(it);
          const title = $$('input', row)[0]; title.value = it.title; title.oninput = e=>it.title=e.target.value;
          const cat = $$('input', row)[1]; cat.value = it.category||''; cat.oninput = e=>it.category=e.target.value;
          const rm = $('button', row); rm.onclick = ()=>{ App.items.splice(idx,1); renderAdminList(); };
          list.appendChild(row);
        });
      }

      async function importJSON(text){
        try {
          const obj = JSON.parse(text);
          if (!Array.isArray(obj.items)) throw new Error('Invalid file');
          App.items = obj.items.map(x=>({ title: x.title||'Untitled', category: x.category||'', mime: x.mime||'image/jpeg', data: x.data }));
          renderAdminList();
          setStatus('Imported'); setTimeout(()=>setStatus(''), 800);
        } catch (e) { alert('Import failed: ' + (e.message||e)); }
      }

      function exportJSON(){
        if (!App.items.length) return alert('Nothing to export');
        const out = { version: 1, generatedAt: new Date().toISOString(), title: App.title, items: App.items };
        const blob = new Blob([JSON.stringify(out,null,2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'gallery.json';
        a.click();
        URL.revokeObjectURL(a.href);
      }

      // ---------- Viewer ----------
      async function initViewer(){
        $('#viewerUI').classList.remove('hidden');
        $('#viewerBar').classList.remove('hidden');
        $('#appTitle').textContent = 'Portfolio';

        // Controls
        $('#gridBtn').onclick = ()=>{ App.view='grid'; renderAll(); syncURL(); };
        $('#flipBtn').onclick = ()=>{ App.view='flip'; renderAll(); syncURL(); };
        window.addEventListener('keydown', (e)=>{ if (App.view==='flip'){ if (e.key==='ArrowLeft') step(-1); if (e.key==='ArrowRight') step(1); }});

        // Load gallery.json
        try {
          const res = await fetch('./gallery.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('Not found');
          const json = await res.json();
          App.title = json.title || 'Portfolio';
          App.items = (json.items||[]).map(x=>({ title:x.title||'Untitled', category:x.category||'', src: `data:${x.mime||'image/jpeg'};base64,${x.data}` }));
          $('#appTitle').textContent = App.title;
          setBanner('');
        } catch (_) {
          setBanner('No <code>gallery.json</code> found. Ask the admin to export one in <code>?mode=admin</code> and upload it to the repo root.');
          App.items = [];
        }

        renderAll();
      }

      function setBanner(html){
        const b = $('#banner'); if (!html){ b.classList.add('hidden'); b.innerHTML=''; return; }
        b.classList.remove('hidden'); b.innerHTML = html;
      }

      function categories(){
        const set = new Set(); for (const it of App.items){ if (it.category) set.add(it.category); }
        return ['all', ...[...set]];
      }

      function syncURL(){
        const u=new URL(location); u.searchParams.set('mode','view'); u.searchParams.set('view', App.view==='flip'?'flip':'grid'); history.replaceState({},'',u);
      }

      function renderAll(){
        renderTabs();
        $('#gridBtn').classList.toggle('bg-zinc-100', App.view==='grid');
        $('#flipBtn').classList.toggle('bg-zinc-100', App.view==='flip');
        if (App.view==='grid') { $('#gridView').classList.remove('hidden'); $('#flipView').classList.add('hidden'); renderGrid(); }
        else { $('#gridView').classList.add('hidden'); $('#flipView').classList.remove('hidden'); renderFlip(); }
      }

      function renderTabs(){
        const ct = $('#catTabs'); ct.innerHTML='';
        const cats = categories();
        cats.forEach(c=>{
          const b=document.createElement('button');
          const active = (App.filter===c) || (App.filter==='all' && c==='all');
          b.className = 'px-3 py-1.5 text-sm rounded-xl border ' + (active? 'bg-zinc-900 text-white border-zinc-900' : 'bg-white hover:bg-zinc-50');
          b.textContent = c==='all' ? 'All' : c; b.onclick = ()=>{ App.filter=c; renderAll(); };
          ct.appendChild(b);
        });
      }

      function filtered(){ return App.filter==='all' ? App.items : App.items.filter(i=>i.category===App.filter); }

      function renderGrid(){
        const host = $('#gridView'); host.innerHTML='';
        if (!App.items.length){ host.innerHTML = '<div class="text-sm text-zinc-500">No items to show.</div>'; return; }
        // If All: group by category
        if (App.filter==='all'){
          const groups = groupBy(App.items, x=>x.category||'Uncategorized');
          for (const [cat, list] of groups){
            const section = document.createElement('section');
            section.innerHTML = `<h2 class=\"text-base font-semibold mb-2\">${escapeHtml(cat)}</h2>`;
            const grid = document.createElement('div'); grid.className='grid gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4';
            list.forEach(it=>grid.appendChild(gridCard(it, cat)));
            section.appendChild(grid); host.appendChild(section);
          }
        } else {
          const grid = document.createElement('div'); grid.className='grid gap-3 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4';
          filtered().forEach(it=>grid.appendChild(gridCard(it, it.category||'Uncategorized')));
          host.appendChild(grid);
        }
      }

      function gridCard(it, cat){
        const fig=document.createElement('figure'); fig.className='rounded-2xl overflow-hidden border bg-white';
        const img=new Image(); img.src=it.src; img.alt=it.title||''; img.loading='lazy'; img.className='w-full h-48 object-cover bg-zinc-100';
        const cap=document.createElement('figcaption'); cap.className='p-2 text-xs text-zinc-600 flex items-center justify-between';
        cap.innerHTML = `<span class=\"truncate\" title=\"${escapeHtml(it.title)}\">${escapeHtml(it.title)}</span><span class=\"text-zinc-400\">${escapeHtml(cat)}</span>`;
        fig.appendChild(img); fig.appendChild(cap); return fig;
      }

      // ---- Flipbook ----
      let idx=0;
      function renderFlip(){
        const list = filtered();
        App.flat = list;
        if (!list.length){ $('#flipViewport').innerHTML='<div class="text-sm text-zinc-500">No items.</div>'; $('#flipMeta').textContent=''; return; }
        if (idx>=list.length) idx=0;
        showSlide();
        $('#prevBtn').onclick = ()=>step(-1);
        $('#nextBtn').onclick = ()=>step(1);
        const vp=$('#flipViewport'); let sx=0,sy=0,tr=false; vp.onpointerdown=e=>{tr=true;sx=e.clientX;sy=e.clientY}; vp.onpointerup=e=>{ if(!tr)return; tr=false; const dx=e.clientX-sx,dy=e.clientY-sy; if(Math.abs(dx)>40&&Math.abs(dx)>Math.abs(dy)) step(dx<0?1:-1); };
      }
      function step(d){ idx=(idx+d+App.flat.length)%App.flat.length; showSlide(); }
      function showSlide(){
        const it=App.flat[idx]; const vp=$('#flipViewport');
        vp.innerHTML=''; const img=new Image(); img.src=it.src; img.alt=it.title||''; img.className='max-w-full max-h-full rounded-lg shadow'; vp.appendChild(img);
        $('#flipMeta').textContent=`${idx+1} / ${App.flat.length} • ${it.title}${it.category? ' • '+it.category:''}`;
      }

      // ---------- Utils ----------
      function setStatus(msg){ status.textContent = msg||''; }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
      function stripExt(n){ return n.replace(/\.[^.]+$/, '').replace(/[-_]+/g,' ').trim(); }
      function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
      function splitDataUrl(dataUrl){ const m=String(dataUrl).match(/^data:([^;]+);base64,(.*)$/); return [m?.[1]||'image/jpeg', m?.[2]||'']; }
      function toSrc(it){ return `data:${it.mime};base64,${it.data}`; }
      function groupBy(arr, keyFn){ const m=new Map(); for(const x of arr){ const k=keyFn(x); if(!m.has(k)) m.set(k,[]); m.get(k).push(x);} return m; }
    </script>
  </body>
</html>
